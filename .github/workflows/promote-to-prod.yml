name: Promote to PROD
on:
  workflow_dispatch:
    inputs:
      pr_title:
        description: 'Pull request title for the promotion'
        required: true
        default: 'Promote DEV to PROD'

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout DEV repo (this repo)
      - name: Checkout DEV repo
        uses: actions/checkout@v4

      # 2) Prepare a clean artifact of the DEV site
      #    Exclude robots.txt (DEV-only) and CNAME (uses DEV subdomain)
      - name: Build promotion artifact
        run: |
          rm -rf _promote && mkdir _promote
          shopt -s extglob dotglob
          for item in * .*; do
            [[ "$item" == "." || "$item" == ".." ]] && continue
            [[ "$item" == "_promote" ]] && continue
            [[ "$item" == ".git" ]] && continue
            [[ "$item" == ".github" ]] && continue
            [[ "$item" == "robots.txt" ]] && continue
            [[ "$item" == "CNAME" ]] && continue
            cp -R "$item" _promote/ 2>/dev/null || true
          done

      # 3) Checkout the PROD repo side-by-side
      - name: Checkout PROD repo
        uses: actions/checkout@v4
        with:
          repository: lph10gator/portfolio-site
          token: ${{ secrets.PROD_REPO_PAT }}
          path: prod-repo
          fetch-depth: 0

      # 4) Replace PROD contents with the artifact (keep PROD's CNAME if present)
      - name: Sync into PROD working tree
        run: |
          shopt -s dotglob
          if [ -f prod-repo/CNAME ]; then
            cp prod-repo/CNAME CNAME.backup
          fi
          find prod-repo -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +
          cp -R _promote/* prod-repo/ || true
          if [ -f CNAME.backup ]; then
            mv CNAME.backup prod-repo/CNAME
          fi

      # 5) Commit and push a branch to the PROD repo
      - name: Commit & push branch to PROD
        id: push_to_prod
        run: |
          set -e
          cd prod-repo

          # Configure author
          git config user.name "lph10gator"
          git config user.email "156947819+lph10gator@users.noreply.github.com"

          # Make sure the remote uses your PAT (not github-actions[bot])
          git remote set-url origin "https://x-access-token:${{ secrets.PROD_REPO_PAT }}@github.com/lph10gator/portfolio-site.git"

          # New branch for this run
          BRANCH="promote/dev-${{ github.run_number }}"
          git checkout -B "$BRANCH"

          # Stage & commit if there are changes
          if git status --porcelain | grep .; then
            git add -A
            git commit -m "Promote DEV to PROD: $GITHUB_REPOSITORY@$GITHUB_SHA"
            git push -f origin "$BRANCH:$BRANCH"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          else
            echo "No changes to promote."
            echo "branch=" >> "$GITHUB_OUTPUT"
          fi

      # 6) Open a Pull Request in PROD via GitHub API
      - name: Open PR in PROD
        if: steps.push_to_prod.outputs.branch != ''
        run: |
          BRANCH="${{ steps.push_to_prod.outputs.branch }}"
          TITLE="${{ github.event.inputs.pr_title }}"
          BODY=$'Automated promotion from DEV (`portfolio-site-dev`).\nExcludes DEV-only files: robots.txt and CNAME.'
          curl -sS -X POST \
            -H "Authorization: token ${{ secrets.PROD_REPO_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/lph10gator/portfolio-site/pulls \
            -d "$(jq -n --arg t "$TITLE" --arg h "$BRANCH" --arg b "main" --arg body "$BODY" \
                  '{title:$t, head:$h, base:$b, body:$body}')"
